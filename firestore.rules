rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========== HELPER FUNCTIONS ==========
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Get familyId from user document (returns null if doesn't exist)
    function getUserFamilyId() {
      let userDoc = /databases/$(database)/documents/users/$(request.auth.uid);
      return exists(userDoc) ? get(userDoc).data.get('familyId', null) : null;
    }
    
    // Check if user is a member of a specific family
    function isFamilyMember(familyId) {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/families/$(familyId)) &&
             request.auth.uid in get(/databases/$(database)/documents/families/$(familyId)).data.memberIds;
    }

    // Check if user is joining a family (adding themselves to memberIds)
    function isJoiningFamily() {
      return isSignedIn() &&
             // New member list must contain current user
             request.resource.data.memberIds.hasAll([request.auth.uid]) &&
             // New member list must contain all previous members
             request.resource.data.memberIds.hasAll(resource.data.memberIds) &&
             // Size must increase by exactly 1
             request.resource.data.memberIds.size() == resource.data.memberIds.size() + 1 &&
             // Must not change the owner
             request.resource.data.ownerId == resource.data.ownerId;
    }

    // ========== USERS COLLECTION ==========
    match /users/{userId} {
      // Any signed-in user can read any user profile (for family member lookup)
      allow read: if isSignedIn();
      // Users can only write their own profile
      allow write: if isSignedIn() && request.auth.uid == userId;
    }

    // ========== FAMILIES COLLECTION ==========
    match /families/{familyId} {
      // Any authenticated user can create a family or read families (needed for join-by-code)
      allow create, read: if isSignedIn();
      // Members can update/delete, OR non-members can update if they are joining
      allow update: if isFamilyMember(familyId) || isJoiningFamily();
      allow delete: if isFamilyMember(familyId);
      
      // Categories sub-collection - only family members
      match /categories/{catId} {
        allow read, write: if isFamilyMember(familyId);
      }
      
      // Budgets sub-collection - only family members
      match /budgets/{budId} {
        allow read, write: if isFamilyMember(familyId);
      }
    }

    // ========== TRACKING TABS COLLECTION ==========
    match /tracking_tabs/{tabId} {
      // Create: signed in and familyId in data matches user's familyId
      allow create: if isSignedIn() && 
                       getUserFamilyId() != null &&
                       request.resource.data.familyId == getUserFamilyId();
      
      // Read/Update/Delete: document's familyId matches user's familyId
      allow read, update, delete: if isSignedIn() && 
                                     resource.data.familyId == getUserFamilyId();
    }

    // ========== TRANSACTIONS COLLECTION ==========
    match /transactions/{txnId} {
      // Create: signed in with matching familyId and userId
      allow create: if isSignedIn() && 
                       getUserFamilyId() != null &&
                       request.resource.data.familyId == getUserFamilyId() &&
                       request.resource.data.userId == request.auth.uid;
      
      // Read: user can read if familyId matches OR they own the transaction
      allow read: if isSignedIn() && (
        resource.data.familyId == getUserFamilyId() ||
        resource.data.userId == request.auth.uid
      );
      
      // Update/Delete: only the transaction owner
      allow update, delete: if isSignedIn() && 
                               resource.data.userId == request.auth.uid;
    }
  }
}
