rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function getUserFamilyId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.familyId;
    }

    function isFamilyMember(familyId) {
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/families/$(familyId)).data.memberIds;
    }

    // ========== USERS COLLECTION ==========
    match /users/{userId} {
      // Allow user to read/write their own profile
      allow read, write: if isSignedIn() && request.auth.uid == userId;
      
      // Allow family members to see each other's basic profiles (name/photo)
      allow read: if isSignedIn() && getUserFamilyId() == resource.data.familyId;
    }

    // ========== FAMILIES COLLECTION ==========
    match /families/{familyId} {
      // Creation: Any logged in user
      allow create: if isSignedIn();
      
      // Read/Update: Only members of this family
      allow read, update: if isFamilyMember(familyId);
      
      // Ownership sensitive fields (like removing members) should technically be 
      // verified here, but we'll stick to basic member isolation for now.
      
      // Sub-collections (Categories & Budgets)
      match /categories/{catId} {
        allow read, write: if isFamilyMember(familyId);
      }
      match /budgets/{budId} {
        allow read, write: if isFamilyMember(familyId);
      }
    }

    // ========== TRACKING TABS COLLECTION ==========
    match /tracking_tabs/{tabId} {
      // Allow read/write if the user's familyId matches the tab's familyId
      allow create: if isSignedIn() && request.resource.data.familyId == getUserFamilyId();
      allow read, update, delete: if isSignedIn() && resource.data.familyId == getUserFamilyId();
    }

    // ========== TRANSACTIONS COLLECTION ==========
    match /transactions/{txnId} {
      // Create: user's familyId must match
      allow create: if isSignedIn() && request.resource.data.familyId == getUserFamilyId();
      
      // Read: 
      // 1. Shared visibility: any family member
      // 2. Private visibility: only the owner
      allow read: if isSignedIn() && (
        (resource.data.visibility == 'shared' && resource.data.familyId == getUserFamilyId()) ||
        (resource.data.visibility == 'private' && resource.data.userId == request.auth.uid)
      );
      
      // Update/Delete: Only the transaction owner
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
  }
}
